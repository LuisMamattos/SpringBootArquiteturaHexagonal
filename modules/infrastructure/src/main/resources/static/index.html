<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>ORDERS</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      body {
        background: #f5f6fa;
        padding: 40px;
        display: flex;
        justify-content: center;
      }
      .container {
        width: 100%;
        max-width: 800px;
      }
      h2 {
        color: #2f3640;
        margin-bottom: 20px;
        text-align: center;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 25px;
        margin-bottom: 30px;
        transition: transform 0.2s;
      }
      .form-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      input,
      select {
        flex: 1;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #dcdde1;
        font-size: 16px;
        min-width: 120px;
      }
      input:focus,
      select:focus {
        border-color: #0097e6;
        outline: none;
      }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        background: #0097e6;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.2s;
      }
      button:hover {
        background: #00a8ff;
      }
      ul {
        list-style: none;
        margin-top: 15px;
      }
      li {
        background: #f1f2f6;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        font-size: 15px;
      }
      li .entity-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 10px;
      }
      li .entity-header span {
        font-weight: bold;
        color: #2f3640;
      }
      .buttons {
        display: flex;
        gap: 8px;
      }
      .update-btn,
      .delete-btn {
        border: none;
        border-radius: 6px;
        padding: 5px 10px;
        cursor: pointer;
        font-size: 12px;
        font-weight: bold;
      }
      .update-btn {
        background: #487eb0;
        color: white;
      }
      .delete-btn {
        background: #ff4d4f;
        color: white;
      }
      .order-details,
      .order-items,
      .add-item-form {
        margin-top: 10px;
      }
      .order-details {
        font-size: 0.9em;
        color: #57606f;
        line-height: 1.5;
      }
      .order-items ul {
        margin-top: 5px;
        padding-left: 15px;
      }
      .order-items li {
        background: #e5e6eb;
        padding: 8px;
        font-size: 14px;
      }
      .add-item-form {
        display: flex;
        gap: 10px;
        margin-top: 15px;
        border-top: 1px solid #dcdde1;
        padding-top: 15px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h2>Clients</h2>
        <div class="form-group">
          <input id="clientName" placeholder="Name" />
          <input id="clientEmail" placeholder="Email" />
          <button onclick="submitClient()">Save</button>
          <button id="toggleClientsBtn" onclick="toggleClientList()">
            List
          </button>
        </div>
        <ul id="clientList"></ul>
      </div>

      <div class="card">
        <h2>Products</h2>
        <div class="form-group">
          <input id="productName" placeholder="Name" />
          <input id="productPrice" placeholder="Price" type="number" />
          <button onclick="submitProduct()">Save</button>
          <button id="toggleProductsBtn" onclick="toggleProductList()">
            List
          </button>
        </div>
        <ul id="productList"></ul>
      </div>

      <div class="card">
        <h2>Orders</h2>
        <div class="form-group">
          <select id="orderClientId"></select>
          <button onclick="createOrder()">Create New Order</button>
          <button id="toggleOrdersBtn" onclick="toggleOrderList()">
            List Orders
          </button>
        </div>
        <ul id="orderList"></ul>
      </div>
    </div>

    <script>
      let allClients = [];
      let allProducts = [];
      let currentClientId = null;
      let currentProductId = null;

      // --- ON PAGE LOAD ---
      document.addEventListener("DOMContentLoaded", async () => {
        await fetchAndCacheClients();
        await fetchAndCacheProducts();
        populateClientDropdown();
      });

      async function fetchAndCacheClients() {
        const response = await fetch("/clients");
        allClients = await response.json();
      }
      async function fetchAndCacheProducts() {
        const response = await fetch("/products");
        allProducts = await response.json();
      }

      function populateClientDropdown() {
        const select = document.getElementById("orderClientId");
        select.innerHTML = '<option value="">Select a Client</option>';
        allClients.forEach((client) => {
          const option = document.createElement("option");
          option.value = client.id;
          option.textContent = `${client.name} (${client.email})`;
          select.appendChild(option);
        });
      }

      // --- CLIENT FUNCTIONS ---
      function renderClientList() {
        const listElement = document.getElementById("clientList");
        listElement.innerHTML = "";
        allClients.forEach((client) => {
          const listItem = document.createElement("li");
          listItem.innerHTML = `
            <div class="entity-header">
              <span>${client.name} (${client.email})</span>
              <div class="buttons">
                <button class="update-btn" onclick="fillClientForm('${client.id}')">Edit</button>
                <button class="delete-btn" onclick="deleteClient('${client.id}')">Delete</button>
              </div>
            </div>`;
          listElement.appendChild(listItem);
        });
        document.getElementById("toggleClientsBtn").textContent = "Hide List";
      }

      function toggleClientList() {
        const listElement = document.getElementById("clientList");
        if (listElement.innerHTML) {
          listElement.innerHTML = "";
          document.getElementById("toggleClientsBtn").textContent = "List";
        } else {
          renderClientList();
        }
      }

      async function submitClient() {
        currentClientId ? updateClient() : registerClient();
      }

      function fillClientForm(id) {
        const client = allClients.find((c) => c.id === id);
        if (!client) return;
        document.getElementById("clientName").value = client.name;
        document.getElementById("clientEmail").value = client.email;
        currentClientId = client.id;
        window.scrollTo({ top: 0, behavior: "smooth" });
      }

      async function registerClient() {
        const name = document.getElementById("clientName").value;
        const email = document.getElementById("clientEmail").value;
        if (!name || !email) return alert("Please fill in all fields!");

        const response = await fetch("/clients", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email }),
        });

        if (response.ok) {
          alert("Client registered!");
          await fetchAndCacheClients();
          populateClientDropdown();
          if (document.getElementById("clientList").innerHTML)
            renderClientList();
          document.getElementById("clientName").value = "";
          document.getElementById("clientEmail").value = "";
        } else {
          const error = await response.json();
          alert(`Error: ${error.error}`);
        }
      }

      async function updateClient() {
        const name = document.getElementById("clientName").value;
        const email = document.getElementById("clientEmail").value;
        if (!name || !email || !currentClientId) return;

        const response = await fetch(`/clients/${currentClientId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, email }),
        });

        if (response.ok) {
          alert("Client updated!");
          await fetchAndCacheClients();
          populateClientDropdown();
          if (document.getElementById("clientList").innerHTML)
            renderClientList();
          document.getElementById("clientName").value = "";
          document.getElementById("clientEmail").value = "";
          currentClientId = null;
        } else {
          const error = await response.json();
          alert(`Error: ${error.error}`);
        }
      }

      async function deleteClient(id) {
        if (!confirm("Delete this client?")) return;
        const response = await fetch(`/clients/${id}`, { method: "DELETE" });
        if (response.ok) {
          alert("Client deleted!");
          await fetchAndCacheClients();
          populateClientDropdown();
          if (document.getElementById("clientList").innerHTML)
            renderClientList();
        } else {
          alert("Error deleting client.");
        }
      }

      // --- PRODUCT FUNCTIONS (Similar structure) ---
      function renderProductList() {
        const listElement = document.getElementById("productList");
        listElement.innerHTML = "";
        allProducts.forEach((product) => {
          const listItem = document.createElement("li");
          listItem.innerHTML = `
                <div class="entity-header">
                    <span>${product.name} - $${product.price.toFixed(2)}</span>
                    <div class="buttons">
                        <button class="update-btn" onclick="fillProductForm('${
                          product.id
                        }')">Edit</button>
                        <button class="delete-btn" onclick="deleteProduct('${
                          product.id
                        }')">Delete</button>
                    </div>
                </div>`;
          listElement.appendChild(listItem);
        });
        document.getElementById("toggleProductsBtn").textContent = "Hide List";
      }

      function toggleProductList() {
        const listElement = document.getElementById("productList");
        if (listElement.innerHTML) {
          listElement.innerHTML = "";
          document.getElementById("toggleProductsBtn").textContent = "List";
        } else {
          renderProductList();
        }
      }

      function fillProductForm(id) {
        const product = allProducts.find((p) => p.id === id);
        if (!product) return;
        document.getElementById("productName").value = product.name;
        document.getElementById("productPrice").value = product.price;
        currentProductId = product.id;
      }

      async function submitProduct() {
        currentProductId ? updateProduct() : registerProduct();
      }

      async function registerProduct() {
        const name = document.getElementById("productName").value;
        const price = parseFloat(document.getElementById("productPrice").value);
        if (!name || isNaN(price))
          return alert("Please provide a valid name and price!");
        const response = await fetch("/products", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, price }),
        });
        if (response.ok) {
          alert("Product registered!");
          await fetchAndCacheProducts();
          if (document.getElementById("productList").innerHTML)
            renderProductList();
          document.getElementById("productName").value = "";
          document.getElementById("productPrice").value = "";
        } else {
          alert("Error registering product.");
        }
      }

      async function updateProduct() {
        const name = document.getElementById("productName").value;
        const price = parseFloat(document.getElementById("productPrice").value);
        if (!name || isNaN(price) || !currentProductId) return;
        const response = await fetch(`/products/${currentProductId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, price }),
        });
        if (response.ok) {
          alert("Product updated!");
          await fetchAndCacheProducts();
          if (document.getElementById("productList").innerHTML)
            renderProductList();
          document.getElementById("productName").value = "";
          document.getElementById("productPrice").value = "";
          currentProductId = null;
        } else {
          alert("Error updating product.");
        }
      }

      async function deleteProduct(id) {
        if (!confirm("Delete this product?")) return;
        const response = await fetch(`/products/${id}`, { method: "DELETE" });
        if (response.ok) {
          alert("Product deleted!");
          await fetchAndCacheProducts();
          if (document.getElementById("productList").innerHTML)
            renderProductList();
        } else {
          alert("Error deleting product.");
        }
      }

      // --- ORDER FUNCTIONS (NEW AND REWRITTEN) ---
      async function createOrder() {
        const clientId = document.getElementById("orderClientId").value;
        if (!clientId)
          return alert("Please select a client to create an order.");

        try {
          const response = await fetch("/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ clientId }),
          });
          if (!response.ok) throw new Error("Failed to create order.");

          alert("Order created successfully! Now you can add items.");
          if (document.getElementById("orderList").innerHTML) renderOrderList();
        } catch (error) {
          alert(error.message);
        }
      }

      async function renderOrderList() {
        const response = await fetch("/orders"); // This endpoint needs to exist
        if (!response.ok) return;
        const orders = await response.json();
        const listElement = document.getElementById("orderList");
        listElement.innerHTML = "";

        // Populate product dropdown for reuse
        let productOptions = allProducts
          .map(
            (p) =>
              `<option value="${p.id}">${p.name} - $${p.price.toFixed(
                2
              )}</option>`
          )
          .join("");

        orders.forEach((order) => {
          const client = allClients.find((c) => c.id === order.clientId);
          const clientName = client ? `${client.name}` : "Unknown Client";
          const orderDate = new Date(order.orderDate).toLocaleString();

          let itemsHtml = "<ul>";
          if (order.items.length > 0) {
            order.items.forEach((item) => {
              itemsHtml += `<li>${item.quantity}x ${
                item.productName
              } @ $${item.price.toFixed(2)} each</li>`;
            });
          } else {
            itemsHtml += "<li>No items yet.</li>";
          }
          itemsHtml += "</ul>";

          const listItem = document.createElement("li");
          listItem.innerHTML = `
              <div class="entity-header">
                <span>Order #${order.id.substring(0, 8)}...</span>
                <span>Status: <strong>${order.status}</strong></span>
              </div>
              <div class="order-details">
                <strong>Client:</strong> ${clientName}<br>
                <strong>Total:</strong> $${order.totalPrice.toFixed(2)}<br>
                <strong>Date:</strong> ${orderDate}
              </div>
              <div class="order-items">
                <strong>Items:</strong>
                ${itemsHtml}
              </div>
              ${
                order.status === "PENDING"
                  ? `
              <div class="add-item-form">
                <select id="product-select-${order.id}">${productOptions}</select>
                <input id="quantity-input-${order.id}" type="number" value="1" min="1" style="max-width: 80px;">
                <button onclick="addItemToOrder('${order.id}')">Add Item</button>
              </div>`
                  : ""
              }
            `;
          listElement.appendChild(listItem);
        });
        document.getElementById("toggleOrdersBtn").textContent =
          "Hide List Orders";
      }

      function toggleOrderList() {
        const listElement = document.getElementById("orderList");
        if (listElement.innerHTML) {
          listElement.innerHTML = "";
          document.getElementById("toggleOrdersBtn").textContent =
            "List Orders";
        } else {
          renderOrderList();
        }
      }

      async function addItemToOrder(orderId) {
        const productId = document.getElementById(
          `product-select-${orderId}`
        ).value;
        const quantity = parseInt(
          document.getElementById(`quantity-input-${orderId}`).value,
          10
        );

        if (!productId || isNaN(quantity) || quantity <= 0) {
          return alert("Please select a product and enter a valid quantity.");
        }

        try {
          const response = await fetch(`/orders/${orderId}/items`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ productId, quantity }),
          });
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.message || "Failed to add item to order.");
          }
          alert("Item added successfully!");
          renderOrderList(); // Refresh the list to show the new item
        } catch (error) {
          alert(`Error: ${error.message}`);
        }
      }
    </script>
  </body>
</html>
