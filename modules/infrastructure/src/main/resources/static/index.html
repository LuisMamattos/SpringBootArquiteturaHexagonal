<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>CRUD Admin</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      body {
        background: #f5f6fa;
        padding: 40px;
        display: flex;
        justify-content: center;
      }
      .container {
        width: 100%;
        max-width: 800px;
      }
      h2 {
        color: #2f3640;
        margin-bottom: 15px;
        text-align: center;
      }
      .card {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 30px;
        transition: transform 0.2s;
      }
      .card:hover {
        transform: translateY(-3px);
      }
      .form-group {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      input {
        flex: 1;
        padding: 10px 12px;
        border-radius: 8px;
        border: 1px solid #dcdde1;
        font-size: 16px;
        transition: border 0.2s;
      }
      input:focus {
        border-color: #0097e6;
        outline: none;
      }
      button {
        padding: 10px 20px;
        border: none;
        border-radius: 8px;
        background: #0097e6;
        color: white;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.2s, transform 0.2s;
      }
      button:hover {
        background: #00a8ff;
        transform: translateY(-2px);
      }
      ul {
        list-style: none;
        margin-top: 10px;
      }
      li {
        background: #f1f2f6;
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 8px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        font-size: 15px;
      }
      li span {
        font-weight: bold;
        color: #2f3640;
      }
      li .buttons {
        display: flex;
        gap: 5px;
        align-self: flex-end;
        margin-top: 5px;
      }
      .delete-btn {
        background: #ff4d4f;
        color: white;
        border: none;
        border-radius: 6px;
        padding: 3px 8px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .delete-btn:hover {
        background: #ff7875;
      }
      .entity-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }
      .order-details {
        font-size: 0.9em;
        color: #57606f;
        margin-top: 5px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="card">
        <h2>Client Registration</h2>
        <div class="form-group">
          <input id="clientName" placeholder="Name" />
          <input id="clientEmail" placeholder="Email" />
          <button onclick="updateClient()">Update</button>
          <button onclick="registerClient()">Register</button>
          <button id="toggleClientsBtn" onclick="toggleClientList()">
            List
          </button>
        </div>
        <ul id="clientList"></ul>
      </div>

      <div class="card">
        <h2>Product Registration</h2>
        <div class="form-group">
          <input id="productName" placeholder="Name" />
          <input id="productPrice" placeholder="Price" type="number" />
          <button onclick="updateProduct()">Update</button>
          <button onclick="registerProduct()">Register</button>
          <button id="toggleProductsBtn" onclick="toggleProductList()">
            List
          </button>
        </div>
        <ul id="productList"></ul>
      </div>

      <div class="card">
        <h2>Order Management</h2>
        <div class="form-group">
          <input id="orderClientId" placeholder="Client ID" />
          <input
            id="orderProductIds"
            placeholder="Product IDs (comma-separated)"
            style="flex-grow: 2"
          />
          <button onclick="createOrder()">Create Order</button>
          <button id="toggleOrdersBtn" onclick="toggleOrderList()">
            List Orders
          </button>
        </div>
        <ul id="orderList"></ul>
      </div>
    </div>

    <script>
      let allClients = [];
      let allProducts = [];

      async function renderClientList() {
        const response = await fetch("/clients");
        allClients = await response.json();
        const listElement = document.getElementById("clientList");
        listElement.innerHTML = "";
        allClients.forEach((client) => {
          const listItem = document.createElement("li");
          listItem.innerHTML = `
            <div class="entity-display">
                <span>${client.id} - ${client.name} (${client.email})</span>
                <div class="buttons">
                    <button class="update-btn" onclick="fillClientForm('${client.id}', '${client.name}', '${client.email}')">Edit</button>
                    <button class="delete-btn" onclick="deleteClient('${client.id}')">X</button>
                </div>
            </div>
          `;
          listElement.appendChild(listItem);
        });
        document.getElementById("toggleClientsBtn").textContent = "Hide List";
      }

      async function renderProductList() {
        const response = await fetch("/products");
        allProducts = await response.json();
        const listElement = document.getElementById("productList");
        listElement.innerHTML = "";
        allProducts.forEach((product) => {
          const listItem = document.createElement("li");
          listItem.innerHTML = `
            <div class="entity-display">
                <span>${product.id} - ${product.name} ($${product.price.toFixed(
            2
          )})</span>
                <div class="buttons">
                    <button class="update-btn" onclick="fillProductForm('${
                      product.id
                    }','${product.name}','${product.price}')">Edit</button>
                    <button class="delete-btn" onclick="deleteProduct('${
                      product.id
                    }')">X</button>
                </div>
            </div>
          `;
          listElement.appendChild(listItem);
        });
        document.getElementById("toggleProductsBtn").textContent = "Hide List";
      }

      async function renderOrderList() {
        const response = await fetch("/orders");
        const orders = await response.json();
        const listElement = document.getElementById("orderList");
        listElement.innerHTML = "";
        orders.forEach((order) => {
          const productNames = order.products.map((p) => p.name).join(", ");
          const orderDate = new Date(order.orderDate).toLocaleString();
          const listItem = document.createElement("li");
          listItem.innerHTML = `
            <span>Order ID: ${order.id}</span>
            <div class="order-details">
                <strong>Client:</strong> ${order.client.name} (${
            order.client.email
          })<br>
                <strong>Products:</strong> ${productNames}<br>
                <strong>Total:</strong> $${order.totalPrice.toFixed(2)}<br>
                <strong>Date:</strong> ${orderDate}
            </div>
          `;
          listElement.appendChild(listItem);
        });
        document.getElementById("toggleOrdersBtn").textContent =
          "Hide List Orders";
      }

      function toggleClientList() {
        const listElement = document.getElementById("clientList");
        if (listElement.innerHTML) {
          listElement.innerHTML = "";
          document.getElementById("toggleClientsBtn").textContent = "List";
        } else {
          renderClientList();
        }
      }

      function toggleProductList() {
        const listElement = document.getElementById("productList");
        if (listElement.innerHTML) {
          listElement.innerHTML = "";
          document.getElementById("toggleProductsBtn").textContent = "List";
        } else {
          renderProductList();
        }
      }

      function toggleOrderList() {
        const listElement = document.getElementById("orderList");
        if (listElement.innerHTML) {
          listElement.innerHTML = "";
          document.getElementById("toggleOrdersBtn").textContent =
            "List Orders";
        } else {
          renderOrderList();
        }
      }

      async function registerClient() {
        const name = document.getElementById("clientName").value;
        const email = document.getElementById("clientEmail").value;
        if (!name || !email) return alert("Please fill in all fields!");

        try {
          const response = await fetch("/clients", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email }),
          });
          if (response.ok) {
            alert("Client registered successfully!");
            document.getElementById("clientName").value = "";
            document.getElementById("clientEmail").value = "";
            if (document.getElementById("clientList").innerHTML)
              renderClientList();
          } else {
            const errorData = await response.json();
            alert(`Error: ${errorData.error} (Email: ${errorData.email})`);
          }
        } catch (error) {
          alert("A network error occurred. Please try again.");
        }
      }

      async function updateClient() {
        const id = document.getElementById("clientName").dataset.id;
        if (!id) return alert("Select a client to update!");
        const name = document.getElementById("clientName").value;
        const email = document.getElementById("clientEmail").value;
        try {
          const response = await fetch(`/clients/${id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ name, email }),
          });
          if (response.ok) {
            alert("Client updated successfully!");
            document.getElementById("clientName").value = "";
            document.getElementById("clientEmail").value = "";
            document.getElementById("clientName").removeAttribute("data-id");
            if (document.getElementById("clientList").innerHTML)
              renderClientList();
          } else {
            const errorData = await response.json();
            alert(`Error: ${errorData.error}`);
          }
        } catch (error) {
          alert("A network error occurred. Please try again.");
        }
      }

      async function deleteClient(id) {
        if (!confirm("Are you sure you want to delete this client?")) return;
        try {
          const response = await fetch(`/clients/${id}`, { method: "DELETE" });
          if (response.ok) {
            alert("Client deleted successfully!");
            if (document.getElementById("clientList").innerHTML)
              renderClientList();
          } else {
            const errorData = await response.json();
            alert(`Error: ${errorData.error} (ID: ${errorData.id})`);
          }
        } catch (error) {
          alert("A network error occurred. Please try again.");
        }
      }

      function fillClientForm(id, name, email) {
        document.getElementById("clientName").value = name;
        document.getElementById("clientEmail").value = email;
        document.getElementById("clientName").dataset.id = id;
      }

      function fillProductForm(id, name, price) {
        document.getElementById("productName").value = name;
        document.getElementById("productPrice").value = price;
        document.getElementById("productName").dataset.id = id;
      }

      async function registerProduct() {
        const name = document.getElementById("productName").value;
        const price = parseFloat(document.getElementById("productPrice").value);
        if (!name || isNaN(price))
          return alert("Please fill in all fields correctly!");
        const response = await fetch("/products", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, price }),
        });
        if (response.ok) {
          alert("Product registered successfully!");
          document.getElementById("productName").value = "";
          document.getElementById("productPrice").value = "";
          if (document.getElementById("productList").innerHTML)
            renderProductList();
        } else {
          alert("Error registering product.");
        }
      }

      async function updateProduct() {
        const id = document.getElementById("productName").dataset.id;
        if (!id) return alert("Select a product to update!");
        const name = document.getElementById("productName").value;
        const price = parseFloat(document.getElementById("productPrice").value);
        const response = await fetch(`/products/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ name, price }),
        });
        if (response.ok) {
          alert("Product updated successfully!");
          document.getElementById("productName").value = "";
          document.getElementById("productPrice").value = "";
          document.getElementById("productName").removeAttribute("data-id");
          if (document.getElementById("productList").innerHTML)
            renderProductList();
        } else {
          alert("Error updating product.");
        }
      }

      async function deleteProduct(id) {
        if (!confirm("Are you sure you want to delete this product?")) return;
        const response = await fetch(`/products/${id}`, { method: "DELETE" });
        if (response.ok) {
          alert("Product deleted successfully!");
          if (document.getElementById("productList").innerHTML)
            renderProductList();
        } else {
          alert("Error deleting product.");
        }
      }

      async function createOrder() {
        const clientId = document.getElementById("orderClientId").value;
        const productIdsStr = document.getElementById("orderProductIds").value;
        if (!clientId || !productIdsStr) {
          return alert("Please provide a Client ID and Product IDs.");
        }
        try {
          const clientObject = allClients.find((c) => c.id === clientId);
          if (!clientObject)
            return alert(`Client with ID '${clientId}' not found.`);
          const productIds = productIdsStr.split(",").map((id) => id.trim());
          const productObjects = productIds.map((id) => {
            const product = allProducts.find((p) => p.id === id);
            if (!product) throw new Error(`Product with ID '${id}' not found.`);
            return product;
          });
          const orderPayload = {
            client: clientObject,
            products: productObjects,
          };
          const response = await fetch("/orders", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(orderPayload),
          });
          if (!response.ok) throw new Error("Failed to create order.");
          alert("Order created successfully!");
          document.getElementById("orderClientId").value = "";
          document.getElementById("orderProductIds").value = "";
          if (document.getElementById("orderList").innerHTML) renderOrderList();
        } catch (error) {
          alert(error.message);
        }
      }
    </script>
  </body>
</html>
